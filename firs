CREATE TABLE IF NOT EXISTS data.measurement (
    id SERIAL PRIMARY KEY,
    mark TIMESTAMP WITHOUT TIME ZONE,
    city TEXT,
    temperature NUMERIC
);
CREATE OR REPLACE FUNCTION data.create_partition(y1 INTEGER, y2 INTEGER)
    RETURNS VOID
    LANGUAGE PLPGSQL
AS $$
DECLARE
    y INTEGER;
    m INTEGER;
    d0 TIMESTAMP;
    d1 TIMESTAMP;
BEGIN
    FOR y IN y1 .. y2 LOOP
        FOR m IN 1 .. 12 LOOP
            d0 := DATE_TRUNC('MONTH', TIMESTAMP (y || '-' || m || '-01'));
            d1 := d0 + INTERVAL '1 month';
            EXECUTE format('CREATE TABLE IF NOT EXISTS data.measurement_part_y%sm%02d PARTITION OF data.measurement FOR VALUES FROM (%L) TO (%L)',
                           y, m, d0, d1);
            EXECUTE format('INSERT INTO data.measurement_part_y%sm%02d SELECT * FROM data.measurement_all WHERE mark >= %L AND mark < %L',
                           y, m, d0, d1);
        END LOOP;
    END LOOP;
END;
$$;

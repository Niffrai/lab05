CREATE OR REPLACE FUNCTION data.create_partition(y1 INTEGER, y2 INTEGER) RETURNS VOID AS $$
DECLARE
    d0 TIMESTAMP;
    d1 TIMESTAMP;
    y INTEGER;
    m INTEGER;
BEGIN
    -- Create initial partitioned table
    EXECUTE '
        CREATE TABLE IF NOT EXISTS data.measurement (
            id SERIAL,
            mark TIMESTAMP WITHOUT TIME ZONE,
            temperature DOUBLE PRECISION,
            city INTEGER,
            PRIMARY KEY (mark, id)
        )
        PARTITION BY RANGE (mark)
    ';

    FOR y IN y1 .. y2 LOOP
        FOR m IN 1 .. 12 LOOP
            d0 := DATE_TRUNC('MONTH', MAKE_DATE(y, m, 1));
            d1 := (d0 + INTERVAL '1 month')::DATE - INTERVAL '1 day';
            EXECUTE format('
                CREATE TABLE IF NOT EXISTS data.measurement_part_y%sm%s PARTITION OF data.measurement
                FOR VALUES FROM (%L) TO (%L)',
                LPAD(y::TEXT, 4, '0'), LPAD(m::TEXT, 2, '0'), d0, d1);

            -- Insert data from measurement_all table with temperature constraint
            EXECUTE format('
                INSERT INTO data.measurement_part_y%sm%s (mark, temperature, city)
                SELECT mark, temperature, city
                FROM data.measurement_all
                WHERE EXTRACT(YEAR FROM mark) = %s
                AND EXTRACT(MONTH FROM mark) = %s
                AND temperature >= -98',
                LPAD(y::TEXT, 4, '0'), LPAD(m::TEXT, 2, '0'), y, m);
        END LOOP;
    END LOOP;
END;
$$ LANGUAGE plpgsql;
